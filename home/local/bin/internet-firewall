#!/bin/sh
# Firewall apps - only allow apps run from "internet" group to run
# https://askubuntu.com/a/666171

# unfirewalling case
if [ -f /tmp/internet-firewalled ]; then
    # clear previous rules
    sudo iptables -F
    # restore saved rules.
    sudo iptables-restore /etc/iptables/iptables.rules

    # delete lock file
    rm /tmp/internet-firewalled

    # nothing else to do, leave
else
    # firewalling Case
    # accept packets for internet group
    sudo iptables -A OUTPUT -p all -m owner --gid-owner internet -j ACCEPT
    # accept packets for proxy user
    sudo iptables -A OUTPUT -p all -m owner --uid-owner proxy -j ACCEPT
    
    # also allow local connections
    sudo iptables -A OUTPUT -p all -d 127.0.0.1 -j ACCEPT
    sudo iptables -A OUTPUT -p all -d 192.168.0.1/24 -j ACCEPT
    sudo iptables -A OUTPUT -p all -d 192.168.1.1/24 -j ACCEPT
    
    # also allow DNS servers
    sudo iptables -A OUTPUT -p all -d 8.8.8.8 -j ACCEPT
    sudo iptables -A OUTPUT -p all -d 4.2.2.4 -j ACCEPT
    
    # allow avahi and android usb tether
    sudo iptables -A OUTPUT -p udp  --dport 5353 -j ACCEPT
    sudo iptables -A OUTPUT -p all -d 192.168.42.1/24 -j ACCEPT

    # reject packets for other users
    sudo iptables -A OUTPUT -j REJECT
    
    touch /tmp/internet-firewalled
fi

OPTIND=1
setIcon=true

while getopts ":i" opt; do
    case "$opt" in
        i) setIcon=false
            ;;
    esac
done

# set awesome icon
if $setIcon; then
    echo "fwWidget.toggle_icon()" | awesome-client
fi
